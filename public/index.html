<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ZeroWebui</title>
    <meta name="mobile-web-app-capable" content="yes" />
    <link rel="stylesheet" href="/static/windows-ui/icons/winui-icons.min.css" />
    <link rel="stylesheet" type="text/css" href="/static/windows-ui/config/app-config.css" />
    <link rel="stylesheet" type="text/css" href="/static/windows-ui/windows-ui.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body, html {
            overflow: hidden;
        }
        .app-page-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Use full viewport height */
            padding: 0;
        }
        #chat-messages {
            flex-grow: 1; /* Allow this area to grow and fill available space */
            overflow-y: auto; /* Enable vertical scrolling for messages */
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        .message {
            max-width: 80%;
            padding: 0.75rem 1.25rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #0078d4;
            color: white;
            align-self: flex-end;
        }
        .bot-message {
            background-color: #f0f0f0;
            color: black;
            align-self: flex-start;
        }
        .bot-message.loading::after {
            content: 'â–‹';
            animation: blink 1s step-end infinite;
            display: inline-block;
            margin-left: 4px;
        }
        @keyframes blink {
            from, to { opacity: 1; }
            50% { opacity: 0; }
        }
    </style>
</head>
<body>
<div class="container-flex-row">
    <aside class="app-navbar-wrap" id="NavBarMain">
        <div class="app-navbar-header-mobile">
            <span class="app-navbar-toggler" data-win-toggle="navbar-left" data-win-target="#NavBarMain"></span>
            <div style="display: flex; justify-content: space-between; flex: 1;">
                <span class="app-navbar-name">ZeroWebui</span>
            </div>
        </div>
        <nav class="app-navbar">
            <div class="app-navbar-header">
                <span class="app-navbar-toggler" data-win-toggle="navbar-left" data-win-target="#NavBarMain" aria-controls="NavBarMain" aria-label="Toggle navigation"></span>
                <span class="app-navbar-name">ZeroWebui</span>
            </div>
            <ul class="app-navbar-list" id="app-navbar-list">
                <label class="app-navbar-theme-switch">
                    <input id="app-navbar-theme-switch" type="checkbox">
                    <div class="app-navbar-theme-switch-icon"></div>
                </label>
                <li class="app-navbar-list-item">
                    <a href="/" class="">
                        <i class="icons10-home"></i>
                        <span>Home</span>
                    </a>
                </li>

            </ul>
        </nav>
    </aside>
    <main class="app-page-container no-padding">
        <h1></h1>
        <div id="error-alert" class="app-alert-bar alert-bar-danger" role="alert">
            <i class="icons10-cross app-color-danger"></i>
            <strong class="app-color-danger">Error</strong> <span id="error-text">message</span>
        </div>

        <div id="models-loading" class="app-loader-bar animate" style="width: 100%;"></div>
        <button id="model-selector-btn" class="app-btn" type="button" data-win-toggle="modal" data-win-target="#models-dialog">
            <span><i class="icons10-explore"></i></span>
        </button>
        <div class="app-dialog" id="models-dialog" data-win-toggle="modal" data-win-target="#MyDialog" tabindex="-1">
            <div class="app-dialog-modal" aria-modal="true" role="dialog">
                <div class="app-dialog-header">
                    <h3>Models</h3>
                </div>
                <div class="app-dialog-body">
                    <table id="modelTable">
                        <tbody></tbody>
                    </table>
                </div>
                <div class="app-dialog-footer">
                    <button class="app-btn" type="button" data-win-toggle="modal" data-win-target="#models-dialog">
                        <span>OK</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="chat-messages">
            <div class="message bot-message">
                Hi there! I am an AI assistant powered by Ollama. How can I help you today?
            </div>
        </div>


        <div class="app-input-container" style="padding: 1rem; border-top: 1px solid #ddd;">
            <label>
                <input id="chat-input" class="app-input-text" type="text" placeholder="Select a model to begin..." disabled>
            </label>
            <button id="send-button" class="app-btn" disabled>
                <span>Send</span>
            </button>
        </div>
    </main>
</div>
</body>
<script src="/static/windows-ui/windows-ui.min.js"></script>
<script src="/static/jquery.js"></script>
<script>
    const base = "/api/";
    let selectedModel = null;

    function f(o){
        return base+o
    }
    //ping
    $.ajax({
        url: f("ping"),
        type: "GET",
        dataType: "json",
        timeout: 0, // Disable timeout
        success: (data)=>{
            if (data.status === "pong"){
                $("#error-alert").hide()
            }else if(data.status === "error"){
                $("#error-alert").show()
                $("#error-text").text("Ollama not available.")
            }
        }
    })

    //models
    $.getJSON(f("tags"), function (data) {
        const $tbody = $("#modelTable tbody");
        $.each(data["models"], function (index, item) {
            const $row = $("<tr>");
            $row.append("<td>" + item.name + "</td>");
            $row.append("<td>" + item.details.quantization_level + "</td>");
            const $btn = $("<button>")
                .addClass("app-btn")
                .html("<i class=\"icons10-checked\"></i>")
                .data("title", item.name);
            $row.append($("<td>").append($btn));
            $tbody.append($row);
        });
        $("#models-loading").hide()
    });

    $("#modelTable").on("click", "button", function ()
        $("#modelTable button").removeClass("app-btn-primary");
        // Add highlight to the clicked button
        $(this).removeClass("app-btn").addClass("app-btn app-btn-primary");

        selectedModel = $(this).data("title");

        // Enable chat input and button
        $("#chat-input").prop("disabled", false).attr("placeholder", `Chat with ${selectedModel}`);
        $("#send-button").prop("disabled", false);

        // Update the model selector button text
        $("#model-selector-btn span").text(selectedModel);

        // Close the modal and focus the input
        new WindowsUI.Modal('#models-dialog').hide();
        $("#chat-input").focus();
    });

    function buildConversationHistory() {
        const history = [];
        $('#chat-messages .message').each(function() {
            const role = $(this).hasClass('user-message') ? 'user' : 'assistant';
            const content = $(this).html(); // Use html() to preserve markdown for re-rendering if needed
            history.push({ role, content });
        });
        return history;
    }

    async function sendMessage() {
        const $chatInput = $("#chat-input");
        const $sendButton = $("#send-button");
        const $chatMessages = $("#chat-messages");

        const messageText = $chatInput.val().trim();
        if (!messageText || !selectedModel) return;

        // Add user message to UI
        $chatMessages.append(`<div class="message user-message">${messageText}</div>`);
        $chatInput.val("");

        // Disable input while processing
        $chatInput.prop("disabled", true);
        $sendButton.prop("disabled", true);

        // Create bot message placeholder with loading indicator
        const $botMessageDiv = $('<div class="message bot-message loading"></div>');
        $chatMessages.append($botMessageDiv);

        // Scroll to the latest message
        $chatMessages.scrollTop($chatMessages[0].scrollHeight);

        const conversationHistory = buildConversationHistory();

        try {
            // The fetch API does not have a default timeout, which is ideal for long-running
            // streaming responses.
            const response = await fetch(f('chat'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: selectedModel,
                    messages: conversationHistory,
                    stream: true
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = "";
            let fullResponse = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) {
                    $botMessageDiv.removeClass('loading');
                    // The stream is complete. Process any remaining text in the buffer.
                    if (buffer.trim()) {
                        try {
                            const data = JSON.parse(buffer);
                            if (data.message && data.message.content) {
                                fullResponse += data.message.content;
                                $botMessageDiv.html(marked.parse(fullResponse));
                            }
                        } catch (e) {
                            console.error("Error parsing final data from stream:", e, "Buffer:", buffer);
                        }
                    }
                    break;
                }

                buffer += decoder.decode(value, { stream: true });

                // The stream may concatenate JSON objects without newlines.
                // We'll normalize by adding a newline between '}{'.
                const normalizedBuffer = buffer.replace(/}\s*{/g, '}\n{');
                const lines = normalizedBuffer.split('\n');

                // The last item might be an incomplete JSON object. We keep it in the buffer.
                buffer = lines.pop() || "";

                for (const line of lines) {
                    if (line.trim() === "") continue;
                    try {
                        const data = JSON.parse(line);
                        if (data.message && data.message.content) {
                            fullResponse += data.message.content;
                            $botMessageDiv.html(marked.parse(fullResponse));
                            $chatMessages.scrollTop($chatMessages[0].scrollHeight);
                        }
                    } catch (error) {
                        // This can happen if a line is still incomplete.
                        // We'll prepend it to the buffer to be processed with the next chunk.
                        console.warn("Failed to parse JSON line, re-buffering:", line);
                        buffer = line + buffer;
                    }
                }
            }
        } catch (error) {
            $botMessageDiv.removeClass('loading').addClass('app-bg-danger').text("An error occurred. Please check the console.");
            console.error("Error during chat fetch:", error);
        } finally {
            // Re-enable input
            $chatInput.prop("disabled", false).focus();
            $sendButton.prop("disabled", false);
        }
    }

    $("#send-button").on("click", sendMessage);
    $("#chat-input").on("keypress", function(e) {
        if (e.which === 13 && !e.shiftKey) { // Enter key
            e.preventDefault();
            sendMessage();
        }
    });
</script>
</html>